<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trouve le One Piece</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pirata+One&family=Nunito:wght@300;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Nunito', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .title-font { font-family: 'Pirata One', cursive; }
    .parchment { background: linear-gradient(180deg,#fff7e6,#fff1d6); box-shadow: 0 8px 30px rgba(0,0,0,0.25); border: 6px solid #6b3f1e; border-radius: 16px; }
    .rope { border: 6px dashed rgba(107,63,30,0.8); border-radius: 12px; }
    .onepiece-bg { background: radial-gradient(circle at 10% 10%, #fef3c7, transparent 15%), linear-gradient(180deg,#0ea5a4 0%, #38bdf8 100%); }
    .logo { width:56px; height:56px; border-radius:50%; object-fit:cover }
    .scroll { background: #fdf6e3 url('One piece/parchment.jpeg') repeat; border: 4px solid #6b3f1e; border-radius: 12px; padding: 1rem; box-shadow: inset 0 0 10px rgba(0,0,0,0.3); }
    .main-content { height: auto; min-height: auto; }
  </style>
</head>
<body class="onepiece-bg min-h-screen flex items-center justify-center p-6">
  <div class="max-w-4xl w-full grid grid-cols-12 gap-6">
    <!-- HEADER -->
    <header class="col-span-12 flex items-center justify-between mb-2">
      <div class="flex items-center gap-4">
        <div class="parchment p-3 flex items-center gap-3">
          <img src="One piece/luffy.jpeg" alt="Luffy" class="logo" />
          <div>
            <h1 class="title-font text-2xl">Trouve le One Piece</h1>
            <p class="text-xs">prends exemple sur moi, Monkey D Luffy</p>
          </div>
        </div>
      </div>
      <div class="parchment p-3 text-right">
        <div class="text-sm">Temps restant</div>
        <div id="timerDisplay" class="text-2xl font-bold">60:00</div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="col-span-8 scroll rope main-content">
      <div class="flex flex-col gap-4">
        <div class="flex items-center justify-between">
          <div>
            <button id="startBtn" class="px-4 py-2 rounded-lg bg-amber-500 hover:bg-amber-400 font-semibold">D√©marrer (60 min)</button>
            <button id="resetBtn" class="ml-3 px-3 py-2 rounded-lg bg-gray-200 hover:bg-gray-100">R√©initialiser</button>
          </div>

          <div class="flex flex-col gap-2 relative">
            <button id="hintBtn" class="px-3 py-2 rounded-lg bg-rose-500 text-white">Indices (5 max)</button>
            <div id="hintSteps" class="absolute top-full left-0 mt-2 flex flex-col gap-2 hidden bg-white p-2 rounded shadow-lg z-10 w-max">
              <button class="step-btn px-3 py-2 rounded bg-amber-400 text-white font-semibold" data-step="0">Step 1</button>
              <button class="step-btn px-3 py-2 rounded bg-amber-400 text-white font-semibold" data-step="1">Step 2</button>
              <button class="step-btn px-3 py-2 rounded bg-amber-400 text-white font-semibold" data-step="2">Step 3</button>
              <button class="step-btn px-3 py-2 rounded bg-amber-400 text-white font-semibold" data-step="3">Step 4</button>
              <button class="step-btn px-3 py-2 rounded bg-amber-400 text-white font-semibold" data-step="4">Step 5</button>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <button id="qrBtn" class="px-3 py-2 rounded-lg bg-white border">üì∑ Scanner QR</button>
          </div>
        </div>

        <section id="qrSection" class="hidden">
          <div id="qr-reader" class="w-full" style="min-height:240px"></div>
          <div id="qr-result" class="mt-2 text-sm text-gray-700"></div>
        </section>

        <section class="flex items-center justify-center">
          <img src="One piece/flag.jpeg" alt="Drapeau Luffy" class="w-40" />
        </section>
      </div>
    </main>

    <!-- ASIDE -->
    <aside class="col-span-4 scroll">
      <h3 class="text-lg font-semibold mb-3">Indices (co√ªt : 5min)</h3>

<!-- Bloc pour afficher l'indice actuel plus en avant -->
<div id="currentHint" class="mb-4 p-3 bg-yellow-100 border-l-4 border-amber-500 rounded font-semibold text-gray-800 hidden"></div>

<ol id="hintsList" class="list-decimal pl-5 space-y-2 text-sm text-gray-800"></ol>


      <!-- Modal Nami -->
      <div id="namiModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
        <div class="parchment p-6 w-11/12 max-w-xl flex items-center gap-4">
          <img src="One piece/nami.jpeg" alt="Nami" class="w-20 h-20 object-cover rounded-full flex-shrink-0" />
          <div id="namiMessage" class="mt-2 font-semibold text-sm text-gray-800"></div>
          <div class="ml-auto mt-4 flex gap-2">
  <button id="namiCloseBtn" class="px-4 py-2 rounded bg-lime-500">Ok</button>
  <button id="namiRefuseBtn" class="px-4 py-2 rounded bg-red-500 text-white">Je suis un rat</button>
</div>

        </div>
      </div>

      <ol id="hintsList" class="list-decimal pl-5 space-y-2 text-sm text-gray-800"></ol>

      <div class="mt-6">
        <h3 class="text-lg font-semibold">Scans & r√©sultats</h3>
        <div id="scanOutput" class="mt-2 p-3 bg-white rounded-md border h-32 overflow-auto"></div>
      </div>

      <div class="mt-6 text-center">
        <button id="finishBtn" class="px-4 py-2 rounded-lg bg-lime-500">Terminer le jeu</button>
      </div>
    </aside>

    <!-- √âcran final Equipage -->
    <div id="crewScreen" class="hidden col-span-12 w-full flex justify-center items-center mt-6">
      <img src="One piece/Equipage.jpeg" alt="Equipage" class="max-w-full h-auto rounded-lg shadow-lg" />
    </div>

    <footer class="col-span-12 text-center mt-4 text-xs text-gray-700">
      Test en local : place le dossier <code>One piece/</code> √† c√¥t√© du fichier HTML, et ouvre <code>escape-onepiece.html</code> dans ton navigateur. 
      Pour la cam√©ra, sert le site en HTTPS ou sur localhost.
    </footer>
  </div>

  <!-- MODALS -->
  <!-- Modal Terminer -->
  <div id="finishModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="parchment p-6 w-11/12 max-w-xl">
      <h3 class="text-2xl title-font mb-4">Avez-vous vraiment termin√© ?</h3>
      <div id="finishChoices" class="flex gap-4">
        <button id="finishYes" class="px-4 py-2 rounded bg-amber-500">Oui</button>
        <button id="finishNo" class="px-4 py-2 rounded bg-gray-300">Non</button>
      </div>
      <div id="finishPhrase" class="mt-4 font-semibold"></div>
      <div id="finishCloseContainer" class="mt-4 hidden text-center">
        <button id="finishCloseBtn" class="px-4 py-2 rounded bg-lime-500">Termin√©</button>
      </div>
    </div>
  </div>

  <!-- Modal Moussaillon final -->
  <div id="endModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="parchment p-6 w-11/12 max-w-xl">
      <h3 class="text-2xl title-font mb-4">Alors Moussaillon, tu as trouv√© le One Piece ?</h3>
      <div id="endChoices" class="flex gap-4">
        <button id="btnYes" class="px-4 py-2 rounded bg-amber-500">√âvidemment</button>
        <button id="btnNo" class="px-4 py-2 rounded bg-gray-300">Non</button>
      </div>
      <div id="endPhrase" class="mt-4 font-semibold"></div>
      <div id="closeBtnContainer" class="mt-4 hidden text-center">
        <button id="closeBtn" class="px-4 py-2 rounded bg-lime-500">Termin√©</button>
      </div>
    </div>
  </div>

<script>
  const MAX_HINTS = 5;
  const HINT_PENALTY = 300; 
  const TOTAL_TIME = 3600;

  let timer = TOTAL_TIME;
  let timerInterval = null;
  let started = false;
  let hintsUsed = 0;
 const hintsStore = [
  "Indice √©tape 1 : Pff, pourquoi faut-il toujours partager les tr√©sors avec la famille‚Ä¶ ‚Äî Nami",
  "Indice √©tape 2 : C‚Äôest √©trange‚Ä¶ des lignes se dessinent sur le papier, mais aucun hi√©roglyphe visible ‚Äî Robin",
  "Indice √©tape 3 : Arrr‚Ä¶ j'ai jamais aim√© le vin‚Ä¶ ‚Äî Brawk !",
  "Indice √©tape 4 : Avec mon sens de l'orientation je suis oblig√©e de suivre l'ordre donn√© ‚Äî Zoro",
  "Indice √©tape 5 : Hiiiii vite ! Usopp a le mal des transports, allons vite chercher des soins en ville ‚Äî Chopper"
];


  const timerDisplay = document.getElementById('timerDisplay');
  const startBtn = document.getElementById('startBtn');
  const resetBtn = document.getElementById('resetBtn');
  const hintBtn = document.getElementById('hintBtn');
  const hintSteps = document.getElementById('hintSteps');
  const hintsList = document.getElementById('hintsList');
  const scanOutput = document.getElementById('scanOutput');
  const qrBtn = document.getElementById('qrBtn');
  const qrSection = document.getElementById('qrSection');
  const qrResult = document.getElementById('qr-result');
  const finishBtn = document.getElementById('finishBtn');

  const finishModal = document.getElementById('finishModal');
  const finishYes = document.getElementById('finishYes');
  const finishNo = document.getElementById('finishNo');
  const finishChoices = document.getElementById('finishChoices');
  const finishPhrase = document.getElementById('finishPhrase');
  const finishCloseContainer = document.getElementById('finishCloseContainer');

  const endModal = document.getElementById('endModal');
  const btnYes = document.getElementById('btnYes');
  const btnNo = document.getElementById('btnNo');
  const endPhrase = document.getElementById('endPhrase');
  const closeBtnContainer = document.getElementById('closeBtnContainer');
  const closeBtn = document.getElementById('closeBtn');

  const crewScreen = document.getElementById('crewScreen');
  const main = document.querySelector('main');
  const aside = document.querySelector('aside');

  function formatTime(s){
    const mm = Math.floor(s/60).toString().padStart(2,'0');
    const ss = (s%60).toString().padStart(2,'0');
    return `${mm}:${ss}`;
  }

  function updateTimerDisplay(){ timerDisplay.textContent = formatTime(timer); }

  function startTimer(){
    if(started) return;
    started = true;
    timerInterval = setInterval(()=>{
      if(timer<=0){ clearInterval(timerInterval); timer=0; updateTimerDisplay(); endGame(); return; }
      timer -= 1; updateTimerDisplay();
    },1000);
  }

  function resetGame(){
    clearInterval(timerInterval);
    timer = TOTAL_TIME; started = false; hintsUsed = 0;
    hintsList.innerHTML=''; scanOutput.innerHTML=''; qrResult.innerHTML=''; updateTimerDisplay();
  }

  startBtn.addEventListener('click', ()=>{ startTimer(); });
  resetBtn.addEventListener('click', ()=>{ if(confirm('R√©initialiser le jeu ?')) resetGame(); });

  // --- Step indices ---
  const stepBtns = document.querySelectorAll('.step-btn');
  hintBtn.addEventListener('click', ()=>{
    if(!started){ alert('D√©marre le timer, tricheur.'); return; }
    hintSteps.classList.toggle('hidden');
  });

// Au clic sur un step
stepBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    const step = parseInt(btn.dataset.step);
    if(hintsUsed >= MAX_HINTS){ alert("Plus d'indices disponibles."); return; }
    if(btn.disabled) return;

    hintSteps.classList.add('hidden'); // cacher menu

    // Afficher message Nami
    const namiModal = document.getElementById('namiModal');
    const namiMessage = document.getElementById('namiMessage');
    namiMessage.textContent = "Ohohoh ! Un indice te co√ªtera 5 Berry... euh, 5 minutes je voulais dire. ‚Äî Nami";
    namiModal.classList.remove('hidden');
    namiModal.style.display = 'flex';

    // Appliquer la p√©nalit√© uniquement si OK est cliqu√©
    const okBtn = document.getElementById('namiCloseBtn');
    okBtn.onclick = ()=>{
      // Appliquer p√©nalit√© et ajouter indice
      if(timer <= HINT_PENALTY){
        if(!confirm("Prendre cet indice va terminer le temps restant ‚Äî confirmer ?")) {
          namiModal.classList.add('hidden');
          return;
        }
      }
      timer = Math.max(0, timer - HINT_PENALTY);
      hintsUsed += 1;

const currentHint = document.getElementById('currentHint');
currentHint.textContent = hintsStore[step];
currentHint.classList.remove('hidden');

      btn.disabled = true;
      btn.classList.add('bg-gray-400', 'cursor-not-allowed');
      btn.classList.remove('bg-amber-400');

      namiModal.classList.add('hidden');
      namiModal.style.display='none';
      updateTimerDisplay();
      if(timer === 0) endGame();
    };
  });
});


  document.getElementById('namiCloseBtn').addEventListener('click', ()=>{
    const namiModal = document.getElementById('namiModal');
    namiModal.classList.add('hidden');
    namiModal.style.display='none';
  });
document.getElementById('namiRefuseBtn').addEventListener('click', ()=>{
  const namiModal = document.getElementById('namiModal');
  namiModal.classList.add('hidden');
  namiModal.style.display = 'none';
  // Ne rien appliquer : pas de p√©nalit√©, pas d'indice ajout√©
});


  // --- QR Code ---
  let html5QrcodeScanner = null;
  qrBtn.addEventListener('click', ()=>{
    if(qrSection.classList.contains('hidden')){ qrSection.classList.remove('hidden'); startQr(); } 
    else { stopQr(); qrSection.classList.add('hidden'); }
  });

  function startQr(){
    html5QrcodeScanner = new Html5Qrcode('qr-reader', { verbose:false });
    Html5Qrcode.getCameras().then(cameras=>{
      const cameraId = cameras && cameras.length ? cameras[0].id : null;
      if(!cameraId){ alert('Aucune cam√©ra d√©tect√©e.'); return; }
      html5QrcodeScanner.start(cameraId, {fps:10, qrbox:250}, qrSuccess, qrError)
        .catch(err=>{ console.error(err); alert('Impossible d\'acc√©der √† la cam√©ra : '+err); });
    }).catch(err=>{ alert('Erreur cam√©ra : '+err); });
  }
  function stopQr(){ if(html5QrcodeScanner){ html5QrcodeScanner.stop().catch(()=>{}); html5QrcodeScanner.clear(); html5QrcodeScanner=null; } }
  function qrSuccess(decodedText){ qrResult.textContent = `QR d√©tect√© : ${decodedText}`; scanOutput.innerHTML += `<div>QR : ${decodedText}</div>`; stopQr(); qrSection.classList.add('hidden'); }
  function qrError(err){ }

  // --- End Game Moussaillon ---
  function endGame(){ endModal.classList.remove('hidden'); endModal.style.display='flex'; }

  btnYes.addEventListener('click', ()=>{
    document.getElementById('endChoices').style.display = 'none';
    endPhrase.textContent = "Tu fais maintenant partie de l'√©quipage du Chapeau de Paille ‚Äî f√™te au banquet !";
    closeBtnContainer.classList.remove('hidden');
  });

  btnNo.addEventListener('click', ()=>{
    document.getElementById('endChoices').style.display = 'none';
    endPhrase.textContent = "Pas grave, moussaillon : la vraie aventure, c'est le voyage. R√©essaie ou savoure un ap√©ro !";
    closeBtnContainer.classList.remove('hidden');
  });

  // --- Terminer Modal ---
  finishBtn.addEventListener('click', ()=>{
    clearInterval(timerInterval); 
    timer = 0; 
    updateTimerDisplay();
    finishModal.classList.remove('hidden');
    finishModal.style.display = 'flex';
    finishChoices.style.display='flex';
    finishPhrase.textContent='';
    finishCloseContainer.classList.add('hidden');
  });

  finishYes.addEventListener('click', ()=>{
    finishChoices.style.display = 'none';
    finishPhrase.textContent = '';
    endModal.classList.remove('hidden');
    endModal.style.display='flex';
    finishModal.classList.add('hidden');
  });

  finishNo.addEventListener('click', ()=>{
    finishModal.classList.add('hidden');    
    finishModal.style.display = 'none';    
  });

  // --- Bouton Termin√© apr√®s √âvidemment / Non ---
  closeBtn.addEventListener('click', ()=>{
    // Masquer modals et zones aside/main
    main.style.display = 'none';
    aside.style.display = 'none';
    finishModal.style.display = 'none';
    endModal.style.display = 'none';

    // Afficher √©cran Equipage
    crewScreen.classList.remove('hidden');
    crewScreen.style.display = 'flex';
  });

  updateTimerDisplay();
  window.addEventListener('beforeunload', ()=>{ stopQr(); });
</script>

</body>
</html>
